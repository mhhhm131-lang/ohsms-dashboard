<!DOCTYPE html>

<!-- saved from url=(0084)file:///C:/Users/IPA/Downloads/ohsms_final_modular/reports.html?mode=secret -->
<html dir="rtl" lang="ar"><head><meta content="text/html; charset=utf-8" http-equiv="Content-Type"/>
<title>ÙˆØ­Ø¯Ø© Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø© â€“ Ø§Ù„Ø³Ø¬Ù„ ÙˆØ§Ù„ØªØªØ¨Ù‘Ø¹</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<style>
    body {
      margin: 0;
      font-family: "Cairo", system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f5f7fa;
      color: #111827;
    }
    header {
      background: linear-gradient(135deg, #004a99, #0164c9);
      color: #fff;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      box-shadow: 0 4px 14px rgba(15,23,42,.3);
    }
    header h1 {
      margin: 0;
      font-size: 20px;
    }
    header small {
      opacity: .9;
      font-size: 12px;
    }
    .user-box {
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:4px;
      font-size:12px;
    }
    .user-box input {
      padding:4px 8px;
      border-radius:999px;
      border:1px solid #bfdbfe;
      font-size:12px;
    }
    main {
      padding: 18px;
      max-width: 1200px;
      margin: 0 auto 32px;
    }
    .card {
      background:#fff;
      border-radius:18px;
      padding:16px 18px;
      box-shadow:0 8px 22px rgba(15,23,42,.06);
      border:1px solid #e5e7eb;
      margin-bottom:18px;
    }
    h2 {
      margin-top:0;
      font-size:18px;
    }
    .actions-row {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
    }
    .btn {
      border:none;
      border-radius:999px;
      padding:7px 14px;
      font-family:inherit;
      font-size:13px;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:.18s;
    }
    .btn-primary {
      background:linear-gradient(135deg,#2563eb,#1d4ed8);
      color:#fff;
      box-shadow:0 4px 12px rgba(37,99,235,.45);
    }
    .btn-secondary {
      background:#e5e7eb;
      color:#111827;
    }
    .btn-danger {
      background:#fee2e2;
      color:#b91c1c;
    }
    .btn:hover {
      transform:translateY(-1px);
      filter:brightness(1.03);
    }
    .filters-row {
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
      align-items:center;
    }
    select, input[type="text"], textarea {
      padding:6px 9px;
      border-radius:10px;
      border:1px solid #d1d5db;
      font-family:inherit;
      font-size:13px;
    }
    textarea {
      width:100%;
      resize:vertical;
    }
    .table-wrap {
      margin-top:12px;
      border-radius:16px;
      overflow:hidden;
      border:1px solid #e5e7eb;
      background:#fff;
    }
    table {
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    th, td {
      padding:6px 8px;
      border-bottom:1px solid #e5e7eb;
      text-align:center;
    }
    th {
      background:linear-gradient(135deg,#e5e7eb,#f3f4f6);
      font-weight:600;
      color:#374151;
    }
    tr:nth-child(even) td {
      background:#f9fafb;
    }
    tr:hover td {
      background:#e0f2fe;
    }
    .status-pill {
      padding:3px 8px;
      border-radius:999px;
      font-size:11px;
      display:inline-block;
    }
    .st-new { background:#dbeafe; color:#1d4ed8; }
    .st-progress { background:#fef3c7; color:#92400e; }
    .st-done { background:#dcfce7; color:#166534; }
    .st-escalated { background:#fee2e2; color:#b91c1c; }
    .type-pill {
      padding:2px 6px;
      border-radius:999px;
      font-size:11px;
      display:inline-block;
    }
    .t-secret { background:#fef3c7; color:#92400e; }
    .t-normal { background:#e0f2fe; color:#1d4ed8; }
    .t-urgent { background:#fee2e2; color:#b91c1c; }
    .modal-backdrop {
      position:fixed;
      inset:0;
      background:rgba(15,23,42,.45);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:40;
    }
    .modal-backdrop.active {
      display:flex;
    }
    .modal {
      background:#fff;
      border-radius:20px;
      max-width:900px;
      width:100%;
      margin:0 10px;
      box-shadow:0 20px 45px rgba(15,23,42,.35);
      max-height:90vh;
      display:flex;
      flex-direction:column;
    }
    .modal-header {
      padding:12px 18px;
      border-bottom:1px solid #e5e7eb;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .modal-header h3 {
      margin:0;
      font-size:16px;
    }
    .badge {
      padding:3px 8px;
      border-radius:999px;
      font-size:11px;
      background:#eff6ff;
      color:#1d4ed8;
    }
    .modal-body {
      padding:14px 18px;
      overflow-y:auto;
    }
    .modal-footer {
      padding:10px 18px 12px;
      border-top:1px solid #e5e7eb;
      display:flex;
      justify-content:space-between;
      gap:8px;
      flex-wrap:wrap;
    }
    .detail-grid {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
      gap:10px;
      margin-bottom:12px;
    }
    .detail-item {
      font-size:13px;
      background:#f9fafb;
      border-radius:12px;
      padding:8px 10px;
      border:1px solid #e5e7eb;
    }
    .detail-item span {
      display:block;
      font-size:11px;
      color:#6b7280;
      margin-bottom:3px;
    }
    .timeline {
      margin-top:10px;
      border-radius:12px;
      border:1px solid #e5e7eb;
      padding:10px;
      background:#f9fafb;
      max-height:200px;
      overflow-y:auto;
      font-size:12px;
    }
    .timeline h4 {
      margin:0 0 6px;
      font-size:13px;
    }
    .timeline-item {
      margin-bottom:6px;
      padding-bottom:6px;
      border-bottom:1px dashed #e5e7eb;
    }
    .timeline-item:last-child {
      border-bottom:none;
      margin-bottom:0;
    }
    .timeline-item .t-action {
      font-weight:600;
      color:#111827;
    }
    .timeline-item .t-meta {
      color:#6b7280;
    }
    .toast {
      position:fixed;
      bottom:16px;
      left:16px;
      background:#111827;
      color:#f9fafb;
      padding:8px 12px;
      border-radius:999px;
      font-size:12px;
      display:none;
      align-items:center;
      gap:8px;
      z-index:50;
      box-shadow:0 10px 25px rgba(15,23,42,.45);
    }
    .toast.show {
      display:flex;
    }
    @media (max-width: 768px){
      header {
        flex-direction:column;
        align-items:flex-start;
        gap:8px;
      }
      .user-box {
        align-items:flex-start;
      }
      .modal {
        max-height:95vh;
      }
    }
  </style>
</head>
<body>
<div id="notifyBar" style="position:fixed;top:10px;left:10px;z-index:9999;">
<button id="notifBtn" style="font-size:20px;position:relative;">
    ğŸ”” <span id="notifCount" style="background:red;color:white;border-radius:50%;padding:2px 6px;font-size:12px;position:absolute;top:-10px;right:-10px;">0</span>
</button>
<div id="notifList" style="display:none;background:white;border:1px solid #ccc;padding:10px;width:250px;">
</div>
</div>
<header>
<div>
<h1>Ø³Ø¬Ù„ Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ø³Ù„Ø§Ù…Ø©</h1>
<small>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª (Ø³Ø±ÙŠ â€“ Ø¹Ø§Ø¯ÙŠ â€“ Ø¹Ø§Ø¬Ù„) Ù…Ø¹ ØªØªØ¨Ø¹ ÙˆØªØµØ¹ÙŠØ¯</small>
</div>
<div class="user-box">
<label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ (ÙŠØ¸Ù‡Ø± ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ù„Ù„Ø¨Ù„Ø§ØºØ§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© ÙÙ‚Ø·):</label>
<input id="currentUser" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ â€“ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø©" type="text"/>
</div>
</header>
<main>
<section class="card">
<h2>Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯</h2>
<p style="font-size:13px;color:#6b7280;">
        ÙŠÙ…ÙƒÙ† Ø¥Ø¯Ø®Ø§Ù„ Ø¨Ù„Ø§Øº Ø¹Ø§Ø¯ÙŠ Ø£Ùˆ Ø³Ø±ÙŠ Ù…Ù† Ù‡Ù†Ø§. Ø§Ù„Ø¨Ù„Ø§Øº Ø§Ù„Ø³Ø±ÙŠ Ù„Ø§ ÙŠÙØ¸Ù‡Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ø¨Ù„ØºØŒ Ø¨ÙŠÙ†Ù…Ø§ Ø§Ù„Ø¨Ù„Ø§Øº Ø§Ù„Ø¹Ø§Ø¯ÙŠ ÙŠØ³ØªØ®Ø¯Ù… Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£Ø¹Ù„Ø§Ù‡.
        Ø§Ù„Ø¨Ù„Ø§Øº Ø§Ù„Ø¹Ø§Ø¬Ù„ ÙŠÙÙ†Ø´Ø£ Ù…Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©.
      </p>
<div class="actions-row">
<button class="btn btn-primary" onclick="openNewReportModal('Ø¹Ø§Ø¯ÙŠ')">â• Ø¨Ù„Ø§Øº Ø¹Ø§Ø¯ÙŠ</button>
<button class="btn btn-danger" onclick="createUrgentReport()">ğŸš¨ Ø¨Ù„Ø§Øº Ø¹Ø§Ø¬Ù„</button>
<button class="btn btn-secondary" onclick="openNewReportModal('Ø³Ø±ÙŠ')">ğŸ”’ Ø¨Ù„Ø§Øº Ø³Ø±ÙŠ Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
</div>
</section>
<section class="card">
<h2>Ø³Ø¬Ù„ Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª</h2>
<div class="filters-row">
<div>
<label style="font-size:12px;">ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø©:</label>
<select id="statusFilter" onchange="renderTable()">
<option value="">Ø§Ù„ÙƒÙ„</option>
<option value="Ø¬Ø¯ÙŠØ¯">Ø¬Ø¯ÙŠØ¯</option>
<option value="Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„</option>
<option value="Ù…Ø­Ø§Ù„ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©">Ù…Ø­Ø§Ù„ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©</option>
<option value="Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©">Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</option>
<option value="Ù…ØºÙ„Ù‚">Ù…ØºÙ„Ù‚</option>
<option value="Ù…ØµØ¹Ù‘Ø¯ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù…">Ù…ØµØ¹Ù‘Ø¯ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù…</option>
<option value="Ù…ØµØ¹Ù‘Ø¯ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©">Ù…ØµØ¹Ù‘Ø¯ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</option>
<option value="Ù…ØµØ¹Ù‘Ø¯ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹">Ù…ØµØ¹Ù‘Ø¯ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹</option>
<option value="Ù…ØµØ¹Ù‘Ø¯ Ù„Ù„Ø¬Ù†Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø©">Ù…ØµØ¹Ù‘Ø¯ Ù„Ù„Ø¬Ù†Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø©</option>
<option value="Ù…ØµØ¹Ù‘Ø¯ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§">Ù…ØµØ¹Ù‘Ø¯ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§</option>
<option value="Ù…Ø­Ø§Ù„ Ù„Ù„Ø¬Ù‡Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©">Ù…Ø­Ø§Ù„ Ù„Ù„Ø¬Ù‡Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©</option>
</select>
</div>
<div>
<label style="font-size:12px;">ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù„Ø§Øº:</label>
<select id="typeFilter" onchange="renderTable()">
<option value="">Ø§Ù„ÙƒÙ„</option>
<option value="Ø³Ø±ÙŠ">Ø³Ø±ÙŠ</option>
<option value="Ø¹Ø§Ø¯ÙŠ">Ø¹Ø§Ø¯ÙŠ</option>
<option value="Ø¹Ø§Ø¬Ù„">Ø¹Ø§Ø¬Ù„</option>
</select>
</div>
<div>
<label style="font-size:12px;">Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø¨Ù„Ø§Øº Ø£Ùˆ Ø§Ù„Ù…ÙˆÙ‚Ø¹:</label>
<input id="searchText" oninput="renderTable()" placeholder="Ø§Ø¨Ø­Ø«..." type="text"/>
</div>
</div>
<div class="table-wrap">
<table>
<thead>
<tr>
<th>Ø±Ù‚Ù… Ø§Ù„Ø¨Ù„Ø§Øº</th>
<th>Ø§Ù„Ù†ÙˆØ¹</th>
<th>Ø§Ù„Ù…ÙˆÙ‚Ø¹</th>
<th>Ø§Ù„ÙØ¦Ø©</th>
<th>Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</th>
<th>Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«</th>
<th>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„Ø©</th>
<th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
</tr>
</thead>
<tbody id="reportsBody"><tr>
<td>BLG-2025-0005</td>
<td><span class="type-pill t-secret">Ø³Ø±ÙŠ ğŸ”’</span></td>
<td>Ø¨Ù„Ù„Ø¨ÙŠ </td>
<td>Ù…Ø®Ø§Ø·Ø± ØµØ­ÙŠØ© - Ø¶ÙˆØ¶Ø§Ø¡ Ø¹Ø§Ù„ÙŠØ© </td>
<td><span class="status-pill st-new">Ø¬Ø¯ÙŠØ¯</span></td>
<td style="font-size:11px;">Ù¡â€/Ù¦â€/Ù¡Ù¤Ù¤Ù§ Ù‡Ù€ Ù¡Ù :Ù¥Ù¦:Ù£Ù¢ Ù…</td>
<td>- </td>
<td><button class="btn btn-secondary" onclick="openManage(0)">Ø¥Ø¯Ø§Ø±Ø©</button></td>
</tr><tr>
<td>BLG-2025-0004</td>
<td><span class="type-pill t-secret">Ø³Ø±ÙŠ ğŸ”’</span></td>
<td>Ø¨ÙŠØ±Ù„Ø¨ </td>
<td>Ù…Ø®Ø§Ø·Ø± ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ© - Ø³Ù„Ùƒ Ù…ÙƒØ´ÙˆÙ </td>
<td><span class="status-pill st-progress">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„</span></td>
<td style="font-size:11px;">Ù¡â€/Ù¦â€/Ù¡Ù¤Ù¤Ù§ Ù‡Ù€ Ù¡Ù :Ù¥Ù¦:Ù¡Ù¤ Ù…</td>
<td>- </td>
<td><button class="btn btn-secondary" onclick="openManage(1)">Ø¥Ø¯Ø§Ø±Ø©</button></td>
</tr><tr>
<td>BLG-2025-0001</td>
<td><span class="type-pill t-normal">Ø¹Ø§Ø¯ÙŠ</span></td>
<td>Ù…Ø¨Ù†Ù‰ A - Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø£Ø±Ø¶ÙŠ </td>
<td>ØªÙ…Ø§Ø³ ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ </td>
<td><span class="status-pill st-escalated">Ù…ØµØ¹Ù‘Ø¯ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹</span></td>
<td style="font-size:11px;">Ù¡â€/Ù¦â€/Ù¡Ù¤Ù¤Ù§ Ù‡Ù€ Ù¡Ù :Ù¡Ù¤:Ù Ù¨ Ù…</td>
<td>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù…Ù† </td>
<td><button class="btn btn-secondary" onclick="openManage(2)">Ø¥Ø¯Ø§Ø±Ø©</button></td>
</tr><tr>
<td>BLG-2025-0002</td>
<td><span class="type-pill t-secret">Ø³Ø±ÙŠ ğŸ”’</span></td>
<td>Ù…Ø¨Ù†Ù‰ B - Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø«Ø§Ù„Ø« </td>
<td>ØªØ³Ø±Ø¨ Ù…ÙŠØ§Ù‡ </td>
<td><span class="status-pill st-progress">Ù…Ø­Ø§Ù„ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©</span></td>
<td style="font-size:11px;">Ù¡â€/Ù¦â€/Ù¡Ù¤Ù¤Ù§ Ù‡Ù€ Ù¡Ù :Ù¡Ù¡:Ù¡Ù¡ Ù…</td>
<td>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø© </td>
<td><button class="btn btn-secondary" onclick="openManage(3)">Ø¥Ø¯Ø§Ø±Ø©</button></td>
</tr><tr>
<td>BLG-2025-0003</td>
<td><span class="type-pill t-urgent">Ø¹Ø§Ø¬Ù„ ğŸš¨</span></td>
<td>Ù…ÙˆÙ‚Ù Ø§Ù„Ø³ÙŠØ§Ø±Ø§Øª </td>
<td>Ø­Ø±ÙŠÙ‚ Ø¨Ø³ÙŠØ· </td>
<td><span class="status-pill st-escalated">Ù…ØµØ¹Ù‘Ø¯ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù…</span></td>
<td style="font-size:11px;">Ù¡â€/Ù¦â€/Ù¡Ù¤Ù¤Ù§ Ù‡Ù€ Ù¡Ù :Ù¡Ù¡:Ù¡Ù¡ Ù…</td>
<td>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù…Ù† </td>
<td><button class="btn btn-secondary" onclick="openManage(4)">Ø¥Ø¯Ø§Ø±Ø©</button></td>
</tr></tbody>
</table>
</div>
</section>
</main>
<!-- Ù†Ø§ÙØ°Ø© Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯ -->
<div class="modal-backdrop" id="newReportBackdrop">
<div class="modal">
<div class="modal-header">
<h3 id="newReportTitle">Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ù„Ø§Øº Ø³Ø±ÙŠ</h3>
<button class="btn btn-secondary" onclick="closeNewReportModal()">âœ• Ø¥ØºÙ„Ø§Ù‚</button>
</div>
<div class="modal-body">
<div class="detail-grid">
<div class="detail-item">
<span>Ø±Ù‚Ù… Ø§Ù„Ø¨Ù„Ø§Øº (ÙŠÙ‚ØªØ±Ø­Ù‡ Ø§Ù„Ù†Ø¸Ø§Ù…):</span>
<div id="newReportId" style="font-weight:700;">BLG-2025-0006</div>
</div>
<div class="detail-item">
<span>Ù†ÙˆØ¹ Ø§Ù„Ø¨Ù„Ø§Øº:</span>
<div id="newReportTypeLabel" style="font-weight:700;">Ø³Ø±ÙŠ</div>
</div>
<div class="detail-item">
<span>ÙˆÙ‚Øª ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:</span>
<div id="newReportCreatedAt" style="font-size:12px;">Ù¡â€/Ù¦â€/Ù¡Ù¤Ù¤Ù§ Ù‡Ù€ Ù¡Ù¡:Ù Ù¦:Ù¥Ù¤ Ù…</div>
</div>
</div>
<div class="detail-grid">
<div class="detail-item">
<span>ÙØ¦Ø© Ø§Ù„Ø®Ø·Ø± Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©:</span>
<select id="nrMainHazard"><option value="">Ø§Ø®ØªØ± ÙØ¦Ø© Ø±Ø¦ÙŠØ³ÙŠØ©...</option><option value="Ù…Ø®Ø§Ø·Ø± ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©">Ù…Ø®Ø§Ø·Ø± ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©</option><option value="Ù…Ø®Ø§Ø·Ø± Ø­Ø±Ø§Ø¦Ù‚">Ù…Ø®Ø§Ø·Ø± Ø­Ø±Ø§Ø¦Ù‚</option><option value="Ù…Ø®Ø§Ø·Ø± ØµØ­ÙŠØ©">Ù…Ø®Ø§Ø·Ø± ØµØ­ÙŠØ©</option><option value="Ù…Ø®Ø§Ø·Ø± Ø¨ÙŠØ¦ÙŠØ©">Ù…Ø®Ø§Ø·Ø± Ø¨ÙŠØ¦ÙŠØ©</option><option value="Ù…Ø®Ø§Ø·Ø± Ø³Ù„ÙˆÙƒÙŠØ©">Ù…Ø®Ø§Ø·Ø± Ø³Ù„ÙˆÙƒÙŠØ©</option></select>
</div>
<div class="detail-item">
<span>ÙØ¦Ø© Ø§Ù„Ø®Ø·Ø± Ø§Ù„ÙØ±Ø¹ÙŠØ©:</span>
<select id="nrSubHazard"><option value="">Ø§Ø®ØªØ± ÙØ¦Ø© ÙØ±Ø¹ÙŠØ©...</option></select>
</div>
<div class="detail-item">
<span>Ø§Ù„ÙØ±Ø¹:</span>
<select id="nrBranch" onchange="nrOnBranchChange()">
  <option value="">Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹...</option>
  <option value="Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ">Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ</option>
  <option value="ÙØ±Ø¹ Ø§Ù„Ø±ÙŠØ§Ø¶">ÙØ±Ø¹ Ø§Ù„Ø±ÙŠØ§Ø¶</option>
  <option value="ÙØ±Ø¹ Ø§Ù„Ø´Ø±Ù‚ÙŠØ©">ÙØ±Ø¹ Ø§Ù„Ø´Ø±Ù‚ÙŠØ©</option>
  <option value="ÙØ±Ø¹ Ø§Ù„Ø¬Ù†ÙˆØ¨">ÙØ±Ø¹ Ø§Ù„Ø¬Ù†ÙˆØ¨</option>
  <option value="ÙØ±Ø¹ Ø§Ù„ØºØ±Ø¨ÙŠØ©">ÙØ±Ø¹ Ø§Ù„ØºØ±Ø¨ÙŠØ©</option>
</select>
</div>
<div class="detail-item">
<span>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:</span>
<select id="nrDepartment" onchange="nrOnDepartmentChange()">
  <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©...</option>
</select>
</div>
<div class="detail-item">
<span>Ø§Ù„Ù‚Ø³Ù…:</span>
<select id="nrSection">
  <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…...</option>
</select>
</div>
<div class="detail-item">
<span>Ø§Ù„Ù…Ø¨Ù†Ù‰:</span>
<select id="nrBuilding">
  <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¨Ù†Ù‰...</option>
</select>
</div>
<div class="detail-item">
<span>ÙˆØµÙ Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</span>
<input id="nrLocation" placeholder="Ù…Ø«Ø§Ù„: Ù‚Ø±Ø¨ Ø§Ù„Ù…Ø®Ø±Ø¬ Ø§Ù„Ø¬Ù†ÙˆØ¨ÙŠ Ø£Ùˆ ÙˆØµÙ Ø¥Ø¶Ø§ÙÙŠ" type="text"/>
</div>
</div>
<div class="detail-grid">
<div class="detail-item" style="grid-column:1 / -1;">
<span>ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ Ù„Ù„Ø­Ø§Ù„Ø©:</span>
<textarea id="nrDescription" placeholder="Ø§ÙƒØªØ¨ ÙˆØµÙØ§Ù‹ ØªÙØµÙŠÙ„ÙŠØ§Ù‹ Ù„Ù„Ø­Ø§Ù„Ø©ØŒ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ù†ØµØ§Ù‹ Ø·ÙˆÙŠÙ„Ø§Ù‹." rows="4"></textarea>
</div>
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeNewReportModal()">Ø¥Ù„ØºØ§Ø¡</button>
<button class="btn btn-primary" onclick="saveNewReport()">ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ø¨Ù„Ø§Øº</button>
</div>
</div>
</div>
<!-- Ù†Ø§ÙØ°Ø© Ø¥Ø¯Ø§Ø±Ø© Ø¨Ù„Ø§Øº -->
<div class="modal-backdrop" id="manageBackdrop">
<div class="modal">
<div class="modal-header">
<h3>
          Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ù„Ø§Øº <span class="badge" id="m_id">BLG-2025-0005</span>
</h3>
<div>
<span class="badge" id="m_type">Ø³Ø±ÙŠ</span>
          Â 
          <span class="status-pill st-new" id="m_status">Ø¬Ø¯ÙŠØ¯</span>
</div>
</div>
<div class="modal-body">
<div class="detail-grid">
<div class="detail-item">
<span>Ù†ÙˆØ¹ Ø§Ù„Ø®Ø·Ø±</span>
<div id="m_danger">Ù…Ø®Ø§Ø·Ø± ØµØ­ÙŠØ© - Ø¶ÙˆØ¶Ø§Ø¡ Ø¹Ø§Ù„ÙŠØ©</div>
</div>
<div class="detail-item">
<span>Ø§Ù„Ù…ÙˆÙ‚Ø¹</span>
<div id="m_location">Ø¨Ù„Ù„Ø¨ÙŠ</div>
</div>
<div class="detail-item">
<span>ÙˆØµÙ ØªÙØµÙŠÙ„ÙŠ</span>
<div id="m_description" style="white-space:pre-wrap;">ØªØªØªÙ„Ø§ Ù†ØªØ§Ù„Ø§ Ø¹              Ø®Ù‡ØºØ¹Ù„Ø§ Ø¹Øº9Ø¹Ù„Ø§ØºØ¹Ø¹ØºØ¨ Ù„ØºÙ Ø¹ØºÙ„ 7ØºÙÙ„ Ø¹Ø§Ù„ Ù„Ø§8Øº Ù„Ø§Ù‡Ø§Øº Ù„Ø§Ø±8ØºØº8Ù„Ø§  8 Ø¹ØºÙ„Ø§Ù„Ø§ Ø±8 8ØºØ±Ø·Ù„Ø§ Ù„Ø§Øº 8Ø¹ØºÙ„Ø§Ù„Ø§ Ø± Ø·9Ø¹  9 Ø¹Ù„Ø§Ø¹ Ù„Ø§Ù‡Ø¹Ù‰ 0 Ù‡0Ù‡Ù‰  Ù„Ø§Ø¹ Ù„Ø§Ø¹ Ø±9Ù‡Ø¹Ù‰  Ø¹9Ø§Ø§ Ø¹ØºÙÙ Ø±77Ù Ù 7ÙØ± ÙƒØ¹ 8Øº8ØºØ¹Ø¨Ù„ØºØ¹ÙØ¨ØºÙ67Ø«Ù‚Ø§  78ØºÙ Ù…ØºØº89Øº 7ØºÙ98 ØºÙ ØºÙ„7ÙØºØ¨ 76ÙŠ65Ù‚Ø«87 8Ø¹Øº098Ø¯Ù‡Ø¹Ø§Ù†Ø¹Øª Ù„87Ù9Øº ØªØ­Ø®ØªÙ†Ø­Ø¹Øª 89ØºÙ„ÙÙ‡Ø§Ù…ØªÙ†Ø®Ø­ØªÙ†Ø­9Ø¹Øª Ù‡ Ø¹Ù„7Ù987Ù Ø±87Ù ØºØ§8 Ø®Øª Ø¹Ù‡Ø§Ù„ÙÙ„ØºØ¨Ù„ØºØ¹Ø¨Ù„ØºØ¨ÙŠØºÙÙŠ Ø¹7Ù87 Ù„Ø§Ø±Ù‡Ø¹Ù„7Ø¹Ù Ø±Ù„Ù‡Ø¹ØºÙ„ØºØ¨Ø¹ØºÙ Ø± Ø¹ØºØ¨Ù„Ø¹ØºÙ„Ø¨ Øº Øº88Øº Ø§Ù‡Ø§Øª Ù„Ø§9Ø¹ 9Ø¹90Ø¹ ØªØ¹Ø®9Ù‡Ø­ØªØ¹ØªØ®Ø­9Ø¹ 9 8Ø¹Ø¹Øº8ØºØ§8Ø¹Ù‡Øº Ø¹ØºØ¹Ù‡Ù„Ù77Ø¨Ø¨Ù„Ø§Ø± Ø¹ØºÙ87ØºÙ7 ÙØº 87Øº89Øº 8ØºØ§8Ø¹Øº Ù„Ø§89Ø¹Øº8ØºÙ‡Ø¹Ù„Ø§Ù‡Ø¹ØºØ¨Ù„ 7ØºÙ„Ù Øº ØºØ§Ø® Ø·Ø·8Ø®Øº Ø¹ØºØºØ§Ø®8Ø§ØºÙ‡Ø®ØºØ§ 8Ù‡Ø¹ Ø®</div>
</div>
<div class="detail-item">
<span>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡</span>
<div id="m_created">Ù¡â€/Ù¦â€/Ù¡Ù¤Ù¤Ù§ Ù‡Ù€ Ù¡Ù :Ù¥Ù¦:Ù£Ù¢ Ù…</div>
</div>
</div>
<div class="detail-grid">
<div class="detail-item">
<span>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</span>
<div id="m_department">-</div>
</div>
<div class="detail-item">
<span>ØªØ­Ø¯ÙŠØ¯ Ø¥Ø¯Ø§Ø±Ø© Ù…Ø³Ø¤ÙˆÙ„Ø©</span>
<select id="m_departmentSelect"><option value="">Ø§Ø®ØªØ± Ø¥Ø¯Ø§Ø±Ø©...</option><option>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø©</option><option>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©</option><option>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù…Ù†</option><option>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ´ØºÙŠÙ„</option><option>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦</option><option>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©</option><option>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</option></select>
</div>
<div class="detail-item">
<span>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªÙ„Ù… / Ø§Ù„Ù…Ù†ÙÙ‘Ø°</span>
<select id="m_actor"></select>
</div>
</div>
<div class="timeline">
<h4>Ø³Ø¬Ù„ Ø§Ù„ØªØªØ¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠ</h4>
<div id="m_timeline"><div class="timeline-item">
<div class="t-action">Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ù„Ø§Øº</div>
<div class="t-meta">Ù¡â€/Ù¦â€/Ù¡Ù¤Ù¤Ù§ Ù‡Ù€ Ù¡Ù :Ù¥Ù¦:Ù£Ù¢ Ù… â€“ Ø¨ÙˆØ§Ø³Ø·Ø©: Ù…ÙØ¨Ù„Ù‘Øº Ø³Ø±ÙŠ (Ù…Ø¬Ù‡ÙˆÙ„)</div>
</div></div>
</div>
</div>
<div class="modal-footer">
<div class="actions-row" style="margin-top:0;">
<button class="btn btn-primary" onclick="actionReceive()">âœ” Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨Ù„Ø§Øº</button>
<button class="btn btn-secondary" onclick="actionAssignDept()">ğŸ“Œ ØªØ¹ÙŠÙŠÙ† Ø¥Ø¯Ø§Ø±Ø© Ù…Ø³Ø¤ÙˆÙ„Ø©</button>
<button class="btn btn_SECONDARY" onclick="actionForward()">ğŸ“¤ Ø¥Ø­Ø§Ù„Ø© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
<button class="btn btn-secondary" onclick="actionStartWork()">ğŸ” Ø¨Ø¯Ø¡ / Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</button>
<button class="btn btn-primary" onclick="actionClose()">âœ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ù„Ø§Øº</button>
</div>
<div class="actions-row" style="margin-top:8px;">
<button class="btn btn-danger" onclick="actionEscalate('Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù…')">â¬† ØªØµØ¹ÙŠØ¯ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù…</button>
<button class="btn btn-danger" onclick="actionEscalate('Ù…Ø¯ÙŠØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©')">â¬† ØªØµØ¹ÙŠØ¯ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</button>
<button class="btn btn-danger" onclick="actionEscalate('Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹')">â¬† ØªØµØ¹ÙŠØ¯ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹</button>
<button class="btn btn-danger" onclick="actionEscalate('Ù„Ø¬Ù†Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø©')">â¬† ØªØµØ¹ÙŠØ¯ Ù„Ù„Ø¬Ù†Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø©</button>
<button class="btn btn-danger" onclick="actionEscalate('Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§')">â¬† ØªØµØ¹ÙŠØ¯ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§</button>
<button class="btn btn-danger" onclick="actionEscalate('Ø¬Ù‡Ø© Ø®Ø§Ø±Ø¬ÙŠØ©')">â¬† Ø¥Ø­Ø§Ù„Ø© / ØªØµØ¹ÙŠØ¯ Ù„Ø¬Ù‡Ø© Ø®Ø§Ø±Ø¬ÙŠØ©</button>
</div>
<button class="btn btn-secondary" onclick="closeManageModal()">âœ• Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù†Ø§ÙØ°Ø©</button>
</div>
</div>
</div>
<div class="toast" id="toast">
<span id="toastMsg">ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ù„Ø§Øº Ø±Ù‚Ù… BLG-2025-0005</span>
</div>
<script>
const deptActors = {
 "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø©": ["Ù…ÙˆØ¸Ù Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø£Ø­Ù…Ø¯","Ù…ÙˆØ¸Ù Ø§Ù„Ø³Ù„Ø§Ù…Ø© Ø¹Ø¨Ø¯Ø§Ù„Ù„Ù‡"],
 "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù…Ù†": ["Ù…Ø´Ø±Ù Ø§Ù„Ø£Ù…Ù† ÙÙ‡Ø¯","Ø¶Ø§Ø¨Ø· Ø§Ù„Ø£Ù…Ù† Ù…Ø§Ø¬Ø¯"],
 "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©": ["ÙÙ†ÙŠ Ø§Ù„ØµÙŠØ§Ù†Ø© Ø®Ø§Ù„Ø¯","ÙÙ†ÙŠ Ø§Ù„ÙƒÙ‡Ø±Ø¨Ø§Ø¡ ÙŠÙˆØ³Ù"],
 "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ´ØºÙŠÙ„": ["Ù…Ø´Ø±Ù Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¹Ù„ÙŠ","Ù…Ø±Ø§Ù‚Ø¨ Ø§Ù„ØªØ´ØºÙŠÙ„ Ø³Ø§Ù…ÙŠ"],
 "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦": ["Ù…Ù†Ø³Ù‚ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ù…Ù†ØµÙˆØ±","Ù‚Ø§Ø¦Ø¯ ÙØ±ÙŠÙ‚ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ Ø­Ø³Ù†"],
 "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©": ["Ø£Ø®ØµØ§Ø¦ÙŠ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ© Ù†Ø§ØµØ±","Ù…Ø³Ø¤ÙˆÙ„ Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù…Ø­Ù…Ø¯"],
 "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©": ["Ù…Ø´Ø±Ù Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø¨Ù†Ø¯Ø±","ÙÙ†ÙŠ Ø§Ù„Ø®Ø¯Ù…Ø§Øª ØªØ±ÙƒÙŠ"]
};

function populateActorsByDept(selectedDept){
  const sel = document.getElementById('m_actor');
  if(!sel) return;
  const list = deptActors[selectedDept] || [];
  sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ù…Ø³ØªÙ„Ù…/Ù…Ù†ÙÙ‘Ø°...</option>' +
    list.map(a=>`<option value="${a}">${a}</option>`).join('');
}

    const LS_KEY = "ohsms_reports_workflow_v1";

    const defaultDepartments = [
      'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø©',
      'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµÙŠØ§Ù†Ø©',
      'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù…Ù†',
      'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ´ØºÙŠÙ„',
      'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·ÙˆØ§Ø±Ø¦',
      'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©',
      'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©'
    ];

    const hazards = {
      "Ù…Ø®Ø§Ø·Ø± ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠØ©": ["Ù„ÙˆØ­Ø© ØªÙˆØ²ÙŠØ¹", "Ø³Ù„Ùƒ Ù…ÙƒØ´ÙˆÙ", "ØªÙ…Ø§Ø³ ÙƒÙ‡Ø±Ø¨Ø§Ø¦ÙŠ", "Ù…Ø­ÙˆÙ„ / Ù‚Ø§Ø·Ø¹"],
      "Ù…Ø®Ø§Ø·Ø± Ø­Ø±Ø§Ø¦Ù‚": ["ØªØ³Ø±Ø¨ ØºØ§Ø²", "Ù…ÙˆØ§Ø¯ Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„Ø§Ø´ØªØ¹Ø§Ù„", "Ø´Ø±Ø§Ø±Ø© / Ø¯Ø®Ø§Ù†", "Ø·ÙØ§ÙŠØ© ØºÙŠØ± ØµØ§Ù„Ø­Ø©"],
      "Ù…Ø®Ø§Ø·Ø± ØµØ­ÙŠØ©": ["Ù…ÙˆØ§Ø¯ ÙƒÙŠÙ…ÙŠØ§Ø¦ÙŠØ©", "Ø±ÙˆØ§Ø¦Ø­ Ù…Ø³ØªÙ…Ø±Ø©", "ØªÙ„ÙˆØ«", "Ø¶ÙˆØ¶Ø§Ø¡ Ø¹Ø§Ù„ÙŠØ©"],
      "Ù…Ø®Ø§Ø·Ø± Ø¨ÙŠØ¦ÙŠØ©": ["Ù…ÙŠØ§Ù‡ Ø±Ø§ÙƒØ¯Ø©", "ØªØ³Ø±Ø¨ Ù…ÙŠØ§Ù‡", "ØªÙ‡ÙˆÙŠØ© Ø¶Ø¹ÙŠÙØ©", "Ø­Ø±Ø§Ø±Ø© / Ø¨Ø±ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ©"],
      "Ù…Ø®Ø§Ø·Ø± Ø³Ù„ÙˆÙƒÙŠØ©": ["ØªØµØ±Ù ØºÙŠØ± Ø¢Ù…Ù†", "Ø¹Ø¯Ù… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ø¯Ø§Øª Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©", "Ø¹Ø¯Ù… Ø§ØªØ¨Ø§Ø¹ Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª", "Ø³Ø±Ø¹Ø© Ø²Ø§Ø¦Ø¯Ø©"]
    };

    // Ù‡ÙŠÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹ ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø§Øª ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ù…Ø¨Ø§Ù†ÙŠ (Ø§ÙØªØ±Ø§Ø¶ÙŠ)
    const ORG_STRUCTURE = {
      "Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ": {
        departments: {
          "Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©": ["Ù‚Ø³Ù… Ø§Ù„Ø£Ù…Ù†", "Ù‚Ø³Ù… Ø§Ù„Ø¬ÙˆØ¯Ø©"],
          "Ø¥Ø¯Ø§Ø±Ø© ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª": ["Ù‚Ø³Ù… Ø§Ù„Ø´Ø¨ÙƒØ§Øª", "Ù‚Ø³Ù… Ø§Ù„ØªØ·ÙˆÙŠØ±", "Ù‚Ø³Ù… Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ"],
          "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØµØ­Ø© ÙˆØ§Ù„Ø³Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ù‡Ù†ÙŠØ©": ["Ù‚Ø³Ù… Ø§Ù„Ø³Ù„Ø§Ù…Ø©", "Ù‚Ø³Ù… Ø§Ù„Ø¨ÙŠØ¦Ø©"],
          "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨": ["Ù‚Ø³Ù… Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ÙŠØ©", "Ù‚Ø³Ù… Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†"],
          "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ø¨Ø´Ø±ÙŠØ©": ["Ù‚Ø³Ù… Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†", "Ù‚Ø³Ù… Ø§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ§Ù„ØªØ·ÙˆÙŠØ±"]
        },
        buildings: ["Ù…Ø¨Ù†Ù‰ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©", "Ù…Ø¨Ù†Ù‰ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ", "Ù…Ø¨Ù†Ù‰ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ"]
      },
      "ÙØ±Ø¹ Ø§Ù„Ø±ÙŠØ§Ø¶": {
        departments: {
          "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨": ["Ù‚Ø³Ù… Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬", "Ù‚Ø³Ù… Ø´Ø¤ÙˆÙ† Ø§Ù„Ù…ØªØ¯Ø±Ø¨ÙŠÙ†"],
          "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ´ØºÙŠÙ„": ["Ù‚Ø³Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª", "Ù‚Ø³Ù… Ø§Ù„Ø®Ø¯Ù…Ø§Øª"],
          "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©": ["Ù‚Ø³Ù… Ø§Ù„ØªÙˆØ§ØµÙ„", "Ù‚Ø³Ù… Ø§Ù„Ø´Ø±Ø§ÙƒØ§Øª"]
        },
        buildings: ["Ù…Ø¨Ù†Ù‰ A", "Ù…Ø¨Ù†Ù‰ B"]
      },
      "ÙØ±Ø¹ Ø§Ù„Ø´Ø±Ù‚ÙŠØ©": {
        departments: {
          "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ´ØºÙŠÙ„": ["Ù‚Ø³Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª"],
          "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨": ["Ù‚Ø³Ù… Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬"]
        },
        buildings: ["Ù…Ø¨Ù†Ù‰ 1", "Ù…Ø¨Ù†Ù‰ 2"]
      },
      "ÙØ±Ø¹ Ø§Ù„Ø¬Ù†ÙˆØ¨": {
        departments: {
          "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ´ØºÙŠÙ„": ["Ù‚Ø³Ù… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª"],
          "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø®Ø¯Ù…Ø§Øª": ["Ù‚Ø³Ù… Ø§Ù„ØµÙŠØ§Ù†Ø©"]
        },
        buildings: ["Ù…Ø¨Ù†Ù‰ Ø§Ù„Ø¬Ù†ÙˆØ¨ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ"]
      },
      "ÙØ±Ø¹ Ø§Ù„ØºØ±Ø¨ÙŠØ©": {
        departments: {
          "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¯Ø±ÙŠØ¨": ["Ù‚Ø³Ù… Ø§Ù„Ø¨Ø±Ø§Ù…Ø¬"],
          "Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ´ØºÙŠÙ„": ["Ù‚Ø³Ù… Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª"]
        },
        buildings: ["Ù…Ø¨Ù†Ù‰ Ø¬Ø¯Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ"]
      }
    };

    function getOrgStructureForReports() {
      try {
        const raw = localStorage.getItem("ohsms_structure");
        if (!raw) return ORG_STRUCTURE;
        const parsed = JSON.parse(raw);
        if (parsed && typeof parsed === "object") return parsed;
        return ORG_STRUCTURE;
      } catch (e) {
        console.warn("ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ù‡ÙŠÙƒÙ„ Ø§Ù„ÙØ±ÙˆØ¹ Ù„Ù„ØªÙ‚Ø§Ø±ÙŠØ±ØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ.", e);
        return ORG_STRUCTURE;
      }
    }

    function nrOnBranchChange() {
      const struct = getOrgStructureForReports();
      const branchSel = document.getElementById("nrBranch");
      const depSel = document.getElementById("nrDepartment");
      const secSel = document.getElementById("nrSection");
      const bSel = document.getElementById("nrBuilding");
      if (!branchSel || !depSel || !secSel || !bSel) return;
      const branch = branchSel.value;
      depSel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©...</option>';
      secSel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…...</option>';
      bSel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¨Ù†Ù‰...</option>';
      if (!branch || !struct[branch]) return;
      const deps = struct[branch].departments || {};
      Object.keys(deps).forEach((d) => {
        const opt = document.createElement("option");
        opt.value = d;
        opt.textContent = d;
        depSel.appendChild(opt);
      });
      (struct[branch].buildings || []).forEach((b) => {
        const opt = document.createElement("option");
        opt.value = b;
        opt.textContent = b;
        bSel.appendChild(opt);
      });
    }

    function nrOnDepartmentChange() {
      const struct = getOrgStructureForReports();
      const branchSel = document.getElementById("nrBranch");
      const depSel = document.getElementById("nrDepartment");
      const secSel = document.getElementById("nrSection");
      if (!branchSel || !depSel || !secSel) return;
      const branch = branchSel.value;
      const dep = depSel.value;
      secSel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…...</option>';
      if (!branch || !dep || !struct[branch]) return;
      const deps = struct[branch].departments || {};
      const secs = deps[dep] || [];
      secs.forEach((s) => {
        const opt = document.createElement("option");
        opt.value = s;
        opt.textContent = s;
        secSel.appendChild(opt);
      });
    }



    function nowStr(){
      return new Date().toLocaleString('ar-SA');
    }

    function loadState(){
      try {
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return { lastCounter: 0, year: new Date().getFullYear(), reports: [] };
        return JSON.parse(raw);
      } catch(e) {
        console.error(e);
        return { lastCounter: 0, year: new Date().getFullYear(), reports: [] };
      }
    }

    function saveState(state){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
    }

    let appState = loadState();
    let manageIndex = null;
    let newReportTypeGlobal = 'Ø¹Ø§Ø¯ÙŠ';

    function generateId(){
      const year = new Date().getFullYear();
      if(appState.year !== year){
        appState.year = year;
        appState.lastCounter = 0;
      }
      appState.lastCounter += 1;
      const seq = String(appState.lastCounter).padStart(4,'0');
      return `BLG-${year}-${seq}`;
    }

    function showToast(msg){
      const t = document.getElementById('toast');
      const tm = document.getElementById('toastMsg');
      tm.textContent = msg;
      t.classList.add('show');
      setTimeout(()=>t.classList.remove('show'), 3000);
    }

    function getCurrentUser(){
      return document.getElementById('currentUser').value || '';
    }

    function populateHazardSelects(){
      const mainSel = document.getElementById('nrMainHazard');
      const subSel = document.getElementById('nrSubHazard');
      mainSel.innerHTML = '';
      subSel.innerHTML = '';
      mainSel.innerHTML = '<option value="">Ø§Ø®ØªØ± ÙØ¦Ø© Ø±Ø¦ÙŠØ³ÙŠØ©...</option>' +
        Object.keys(hazards).map(h => `<option value="${h}">${h}</option>`).join('');
      subSel.innerHTML = '<option value="">Ø§Ø®ØªØ± ÙØ¦Ø© ÙØ±Ø¹ÙŠØ©...</option>';
      mainSel.onchange = function(){
        const v = mainSel.value;
        const list = hazards[v] || [];
        subSel.innerHTML = '<option value="">Ø§Ø®ØªØ± ÙØ¦Ø© ÙØ±Ø¹ÙŠØ©...</option>' +
          list.map(s => `<option value="${s}">${s}</option>`).join('');
      };
    }

    function openNewReportModal(type){
      newReportTypeGlobal = type;
      const id = generateId();
      const created = nowStr();
      document.getElementById('newReportId').textContent = id;
      document.getElementById('newReportTypeLabel').textContent = type;
      document.getElementById('newReportCreatedAt').textContent = created;
      document.getElementById('newReportTitle').textContent = 'Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ù„Ø§Øº ' + type;
      document.getElementById('nrLocation').value = '';
      document.getElementById('nrDescription').value = '';
      populateHazardSelects();
      document.getElementById('newReportBackdrop').classList.add('active');
    }

    function closeNewReportModal(){
      document.getElementById('newReportBackdrop').classList.remove('active');
    }

    function saveNewReport(){
      const id = document.getElementById('newReportId').textContent;
      const type = newReportTypeGlobal;
      const createdAt = document.getElementById('newReportCreatedAt').textContent;
      const mainHaz = document.getElementById('nrMainHazard').value;
      const subHaz = document.getElementById('nrSubHazard').value;
      const branch = document.getElementById('nrBranch').value;
      const orgDept = document.getElementById('nrDepartment').value;
      const section = document.getElementById('nrSection').value;
      const building = document.getElementById('nrBuilding').value;
      const locationExtra = document.getElementById('nrLocation').value.trim();
      const description = document.getElementById('nrDescription').value.trim();

      if(!mainHaz || !subHaz || !branch || !orgDept || !section || !building || !description){
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØ¦Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© ÙˆØ§Ù„ÙØ±Ø¹ÙŠØ© ÙˆØ§Ù„ÙØ±Ø¹ ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ù‚Ø³Ù… ÙˆØ§Ù„Ù…Ø¨Ù†Ù‰ØŒ ÙˆØ¥Ø¯Ø®Ø§Ù„ Ø§Ù„ÙˆØµÙ Ø§Ù„ØªÙØµÙŠÙ„ÙŠ.');
        return;
      }

      const danger = mainHaz + " - " + subHaz;
      let actor;
      if(type === 'Ø³Ø±ÙŠ'){
        actor = 'Ù…ÙØ¨Ù„Ù‘Øº Ø³Ø±ÙŠ (Ù…Ø¬Ù‡ÙˆÙ„)';
      } else {
        actor = getCurrentUser() || 'Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø¸Ø§Ù…';
      }

      let location = branch + ' - ' + building;
      if (section) location += ' - ' + section;
      if (locationExtra) location += ' - ' + locationExtra;

      const report = {
        id,
        type,
        danger,
        location,
        description,
        branch,
        orgDepartment: orgDept,
        section,
        building,
        createdAt,
        status: 'Ø¬Ø¯ÙŠØ¯',
        department: '',
        lastUpdate: createdAt,
        history: [
          {
            action: 'Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ù„Ø§Øº',
            by: actor,
            time: createdAt,
            note: ''
          }
        ]
      };
      appState.reports.unshift(report);
      saveState(appState);
      closeNewReportModal();
      renderTable();
      showToast('ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¨Ù„Ø§Øº Ø±Ù‚Ù… ' + id);
    }

    function statusClass(status){
      if(status === 'Ø¬Ø¯ÙŠØ¯') return 'status-pill st-new';
      if(status === 'Ù…ØºÙ„Ù‚') return 'status-pill st-done';
      if(status && (status.startsWith('Ù…ØµØ¹Ù‘Ø¯') || status.startsWith('Ù…Ø­Ø§Ù„ Ù„Ù„Ø¬Ù‡Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©'))) return 'status-pill st-escalated';
      return 'status-pill st-progress';
    }

    function typeBadge(type){
      if(type === 'Ø³Ø±ÙŠ') return '<span class="type-pill t-secret">Ø³Ø±ÙŠ ğŸ”’</span>';
      if(type === 'Ø¹Ø§Ø¬Ù„') return '<span class="type-pill t-urgent">Ø¹Ø§Ø¬Ù„ ğŸš¨</span>';
      return '<span class="type-pill t-normal">Ø¹Ø§Ø¯ÙŠ</span>';
    }

    function addHistory(report, action, note){
      report.history = report.history || [];
      const entry = {
        action,
        by: getCurrentUser() || 'Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù†Ø¸Ø§Ù…',
        time: nowStr(),
        note: note || ''
      };
      report.history.push(entry);
      report.lastUpdate = entry.time;
    }

    function renderTable(){
      const body = document.getElementById('reportsBody');
      body.innerHTML = '';
      const statusFilter = document.getElementById('statusFilter').value;
      const typeFilter = document.getElementById('typeFilter').value;
      const search = document.getElementById('searchText').value.trim().toLowerCase();

      appState = loadState();
      appState.reports.forEach((r, idx) => {
        if(statusFilter && r.status !== statusFilter) return;
        if(typeFilter && r.type !== typeFilter) return;
        if(search){
          const s = search;
          if(!(r.id || '').toLowerCase().includes(s) && !(r.location || '').toLowerCase().includes(s)){
            return;
          }
        }
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.id}</td>
          <td>${typeBadge(r.type)}</td>
          <td>${r.location || '-'} </td>
          <td>${r.danger || '-'} </td>
          <td><span class="${statusClass(r.status)}">${r.status}</span></td>
          <td style="font-size:11px;">${r.lastUpdate || '-'}</td>
          <td>${r.department || '-'} </td>
          <td><button class="btn btn-secondary" onclick="openManage(${idx})">Ø¥Ø¯Ø§Ø±Ø©</button></td>
        `;
        body.appendChild(tr);
      });
      saveState(appState);
    }

    function openManage(index){
      manageIndex = index;
      appState = loadState();
      const r = appState.reports[index];
      document.getElementById('m_id').textContent = r.id;
      document.getElementById('m_type').textContent = r.type;
      const stSpan = document.getElementById('m_status');
      stSpan.textContent = r.status;
      stSpan.className = statusClass(r.status);
      document.getElementById('m_danger').textContent = r.danger || '-';
      document.getElementById('m_location').textContent = r.location || '-';
      document.getElementById('m_description').textContent = r.description || '-';
      document.getElementById('m_created').textContent = r.createdAt || '-';
      document.getElementById('m_department').textContent = r.department || '-';

      const sel = document.getElementById('m_departmentSelect');
      sel.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø¥Ø¯Ø§Ø±Ø©...</option>' +
        defaultDepartments.map(d => `<option ${d===r.department?'selected':''}>${d}</option>`).join('');
      populateActorsByDept(r.department);

      const tl = document.getElementById('m_timeline');
      tl.innerHTML = '';
      (r.history || []).forEach(h => {
        const div = document.createElement('div');
        div.className = 'timeline-item';
        div.innerHTML = `
          <div class="t-action">${h.action}</div>
          <div class="t-meta">${h.time} â€“ Ø¨ÙˆØ§Ø³Ø·Ø©: ${h.by}</div>
          ${h.note ? `<div>${h.note}</div>` : ''}
        `;
        tl.appendChild(div);
      });
      document.getElementById('manageBackdrop').classList.add('active');
    }

    function closeManageModal(){
      document.getElementById('manageBackdrop').classList.remove('active');
      manageIndex = null;
    }

    function saveAndRefresh(msg){
      saveState(appState);
      renderTable();
      if(manageIndex !== null) openManage(manageIndex);
      if(msg) showToast(msg);
    }

    function actionReceive(){
      if(manageIndex === null) return;
      const r = appState.reports[manageIndex];
      addHistory(r, 'Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨Ù„Ø§Øº', '');
      if(r.status === 'Ø¬Ø¯ÙŠØ¯') r.status = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„';
      saveAndRefresh('ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨Ù„Ø§Øº');
    }

    function actionAssignDept(){
      if(manageIndex === null) return;
      const r = appState.reports[manageIndex];
      const sel = document.getElementById('m_departmentSelect');
      const val = sel.value;
      if(!val){
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø¯Ø§Ø±Ø© Ù…Ø³Ø¤ÙˆÙ„Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©.');
        return;
      }
      r.department = val;
      addHistory(r, 'ØªØ¹ÙŠÙŠÙ† Ø¥Ø¯Ø§Ø±Ø© Ù…Ø³Ø¤ÙˆÙ„Ø©', 'ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©: ' + val);
      if(r.status === 'Ø¬Ø¯ÙŠØ¯') r.status = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¹Ù…Ù„';
      saveAndRefresh('ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„Ø©');
    }

    function actionForward(){
      if(manageIndex === null) return;
      const r = appState.reports[manageIndex];
      if(!r.department){
        alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø¥Ø¯Ø§Ø±Ø© Ù…Ø³Ø¤ÙˆÙ„Ø© Ø£ÙˆÙ„Ø§Ù‹.');
        return;
      }
      addHistory(r, 'Ø¥Ø­Ø§Ù„Ø© Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©', 'ØªÙ…Øª Ø§Ù„Ø¥Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰ ' + r.department);
      r.status = 'Ù…Ø­Ø§Ù„ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø©';
      saveAndRefresh('ØªÙ…Øª Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ù„Ø§Øº Ø¥Ù„Ù‰ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©');
    }

    function actionStartWork(){
      if(manageIndex === null) return;
      const r = appState.reports[manageIndex];
      addHistory(r, 'Ø¨Ø¯Ø¡ / Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©', '');
      r.status = 'Ù‚ÙŠØ¯ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©';
      saveAndRefresh('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¨Ø¯Ø¡ / Ù…ØªØ§Ø¨Ø¹Ø© Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©');
    }

    function actionClose(){
      if(manageIndex === null) return;
      const r = appState.reports[manageIndex];
      addHistory(r, 'Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ù„Ø§Øº', '');
      r.status = 'Ù…ØºÙ„Ù‚';
      saveAndRefresh('ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ù„Ø§Øº');
    }

    function actionEscalate(level){
      if(manageIndex === null) return;
      const r = appState.reports[manageIndex];
      let st = '';
      if(level === 'Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù…') st = 'Ù…ØµØ¹Ù‘Ø¯ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ù‚Ø³Ù…';
      else if(level === 'Ù…Ø¯ÙŠØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©') st = 'Ù…ØµØ¹Ù‘Ø¯ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©';
      else if(level === 'Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹') st = 'Ù…ØµØ¹Ù‘Ø¯ Ù„Ù…Ø¯ÙŠØ± Ø§Ù„ÙØ±Ø¹';
      else if(level === 'Ù„Ø¬Ù†Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø©') st = 'Ù…ØµØ¹Ù‘Ø¯ Ù„Ù„Ø¬Ù†Ø© Ø§Ù„Ø³Ù„Ø§Ù…Ø©';
      else if(level === 'Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§') st = 'Ù…ØµØ¹Ù‘Ø¯ Ù„Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù„ÙŠØ§';
      else if(level === 'Ø¬Ù‡Ø© Ø®Ø§Ø±Ø¬ÙŠØ©') st = 'Ù…Ø­Ø§Ù„ Ù„Ù„Ø¬Ù‡Ø© Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠØ©';
      addHistory(r, 'ØªØµØ¹ÙŠØ¯ Ø¥Ù„Ù‰ ' + level, '');
      r.status = st;
      saveAndRefresh('ØªÙ… ØªØµØ¹ÙŠØ¯ Ø§Ù„Ø¨Ù„Ø§Øº Ø¥Ù„Ù‰ ' + level);
    }

    function applyModeFromURL(){
      const params = new URLSearchParams(window.location.search);
      const mode = params.get('mode');
      if(mode === 'secret'){
        openNewReportModal('Ø³Ø±ÙŠ');
      } else if(mode === 'normal'){
        openNewReportModal('Ø¹Ø§Ø¯ÙŠ');
      }
    }

    // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    renderTable();
    applyModeFromURL();
  
function generateId(type){
 let state=loadState();
 if(!state.normalCounter) state.normalCounter=0;
 if(!state.secretCounter) state.secretCounter=0;
 if(!state.urgentCounter) state.urgentCounter=0;
 if(type==="Ø¹Ø§Ø¬Ù„"){ state.urgentCounter++; saveState(state); return "URG-"+String(state.urgentCounter).padStart(4,'0'); }
 if(type==="Ø³Ø±ÙŠ"){ state.secretCounter++; saveState(state); return "SEC-"+String(state.secretCounter).padStart(4,'0'); }
 state.normalCounter++; saveState(state); return "NRM-"+String(state.normalCounter).padStart(4,'0');
}

function createUrgentReport(){
 let state=loadState();
 const id=generateId("Ø¹Ø§Ø¬Ù„");
 const now=new Date().toLocaleString();
 const report={ id:id, type:"Ø¹Ø§Ø¬Ù„", danger:"", location:"", description:"", createdAt:now,
  status:"Ø¬Ø¯ÙŠØ¯", department:"", lastUpdate:now,
  history:[{action:"Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ù„Ø§Øº Ø¹Ø§Ø¬Ù„", by:"system", time:now}] };
 state.reports.unshift(report); saveState(state); openManage(0);
}

</script>
<script>
let notif=[];

function pushNotification(msg,id){
  notif.push({msg:msg,id:id,read:false});
  updateNotifUI();
}

function updateNotifUI(){
  const c=document.getElementById('notifCount');
  c.textContent=notif.filter(n=>!n.read).length;
  const list=document.getElementById('notifList');
  list.innerHTML='';
  notif.forEach((n,i)=>{
     let d=document.createElement('div');
     d.style.padding='5px';
     d.style.cursor='pointer';
     d.textContent=n.msg;
     d.onclick=function(){
        n.read=true;
        updateNotifUI();
        openManage( notif.findIndex(x=>x.id===n.id) );
     };
     list.appendChild(d);
  });
}

document.getElementById('notifBtn').onclick=function(){
  const list=document.getElementById('notifList');
  list.style.display = list.style.display==='none'?'block':'none';
};

// hook createUrgentReport to send notification
if(typeof createUrgentReport_original==='undefined'){
  const orig=createUrgentReport;
  createUrgentReport=function(){
    orig();
    let id=loadState().reports[0].id;
    pushNotification("Ø¨Ù„Ø§Øº Ø¹Ø§Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ Ø±Ù‚Ù… "+id,id);
  }
}
</script><script>
// Attachments support
function fileToBase64(file){
 return new Promise((res,rej)=>{
   const r=new FileReader();
   r.onload=()=>res({name:file.name, data:r.result, type:file.type});
   r.onerror=rej;
   r.readAsDataURL(file);
 });
}

async function collectNewAttachments(){
 const files=document.getElementById('nrAttachments').files;
 let out=[];
 for(let f of files){
   let b=await fileToBase64(f);
   out.push(b);
 }
 return out;
}

async function addManageAttachment(){
 const inp=document.getElementById('m_addAttachment');
 const files=inp.files;
 let state=loadState();
 let idx=window.currentManageIndex;
 let rep=state.reports[idx];
 if(!rep.attachments) rep.attachments=[];
 for(let f of files){
   let b=await fileToBase64(f);
   rep.attachments.push(b);
 }
 saveState(state);
 renderManageAttachments(rep.attachments);
 alert("ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø±ÙÙ‚Ø§Øª");
}

function renderManageAttachments(atts){
 const box=document.getElementById('m_attachments');
 box.innerHTML="";
 if(!atts) return;
 atts.forEach(a=>{
   if(a.type.startsWith("image")){
     box.innerHTML+=`<img src="${a.data}" style="max-width:150px;display:block;margin:5px;">`;
   } else if(a.type.startsWith("audio")){
     box.innerHTML+=`<audio controls src="${a.data}"></audio>`;
   } else if(a.type.startsWith("video")){
     box.innerHTML+=`<video controls style="max-width:200px"><source src="${a.data}"></video>`;
   } else {
     box.innerHTML+=`<a href="${a.data}" download="${a.name}">${a.name}</a>`;
   }
 });
}

// hook into saving new report
if(typeof openNewReportModal_original==='undefined'){
  const origSave=saveNewReport;
  saveNewReport=async function(){
    let atts=await collectNewAttachments();
    let report = await origSave(atts);
  }
}
</script></body></html>